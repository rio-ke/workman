---
- name: "Install audit Package"
  yum:
    name: audit
    state: present

- name: "Ensure audit log storage size is configured"
  lineinfile:
    dest: /etc/audit/auditd.conf
    regexp: "^max_log_file( |=)"
    line: "max_log_file = {{ audit_log.max_log_file }}"
    state: present

- name: "Ensure system is disabled when audit logs are full"
  lineinfile:
    dest: /etc/audit/auditd.conf
    regexp: "^admin_space_left_action"
    line: "admin_space_left_action = {{ audit_log.admin_space_left_action }}"
    state: present

- name: "Ensure system is disabled when audit logs are full before Mail generated"
  lineinfile:
    dest: /etc/audit/auditd.conf
    regexp: "^space_left_action"
    line: "space_left_action = {{ audit_log.space_left_action }}"
    state: present

- name: "Ensure system is disabled when audit logs are full before Mail generated by root user"
  lineinfile:
    dest: /etc/audit/auditd.conf
    regexp: "^action_mail_acct"
    line: "action_mail_acct = {{ audit_log.action_mail_acct }}"
    state: present

- name: "Ensure audit logs are not automatically deleted"
  lineinfile:
    dest: /etc/audit/auditd.conf
    regexp: "^max_log_file_action"
    line: "max_log_file_action = {{ audit_log.max_log_file_action }}"
    state: present

- name: "Ensure auditd service is enabled"
  service:
    name: auditd
    state: started
    enabled: yes

- name: "Ensure auditing for processes that start prior to auditd is enabled"
  replace:
    dest: /etc/default/grub
    regexp: '(^GRUB_CMDLINE_LINUX\s*\=\s*)(?:")(.+)(?<!audit=1)(?:")'
    replace: '\1"\2 audit=1"'
    follow: yes
  ignore_errors: yes
  register: centos_7_auditd_priority

- name: "update the grub2 configuration"
  shell: grub2-mkconfig > /boot/grub2/grub.cfg
  when: centos_7_auditd_priority is succeeded

- name: "Ensure events that modify date and time information are collected"
  lineinfile:
    dest: /etc/audit/audit.rules
    line: '{{ item }}'
  with_items:
    - -a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
    - -a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
    - -a always,exit -F arch=b64 -S clock_settime -k time-change
    - -a always,exit -F arch=b32 -S clock_settime -k time-change
    - -w /etc/localtime -p wa -k time-change

- name: "Ensure events that modify user/group information are collected"
  lineinfile:
    dest: /etc/audit/audit.rules
    line: '{{item}}'
  with_items:
    - -w /etc/group -p wa -k identity
    - -w /etc/passwd -p wa -k identity
    - -w /etc/gshadow -p wa -k identity
    - -w /etc/shadow -p wa -k identity
    - -w /etc/security/opasswd -p wa -k identity

- name: "Ensure events that modify the system's network environment are collected"
  lineinfile:
    dest: /etc/audit/audit.rules
    line: '{{ item }}'
  with_items:
    - -a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale
    - -a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale
    - -w /etc/issue -p wa -k system-locale
    - -w /etc/issue.net -p wa -k system-locale
    - -w /etc/hosts -p wa -k system-locale
    - -w /etc/sysconfig/network -p wa -k system-locale

- name: "Ensure events that modify the system's Mandatory Access Controls are collected"
  lineinfile:
    dest: /etc/audit/audit.rules
    line: '-w /etc/selinux/ -p wa -k MAC-policy'

- name: "Ensure login and logout events are collected"
  lineinfile:
    dest: /etc/audit/audit.rules
    line: '{{ item }}'
  with_items:
    - -w /var/log/lastlog -p wa -k logins
    - -w /var/run/faillock/ -p wa -k logins

- name: "Ensure session initiation information is collected"
  lineinfile:
    dest: /etc/audit/audit.rules
    line: '{{item}}'
  with_items:
    - -w /var/run/utmp -p wa -k session
    - -w /var/log/wtmp -p wa -k session
    - -w /var/log/btmp -p wa -k session

- name: "Ensure discretionary access control permission modification events are collected"
  lineinfile:
    dest: /etc/audit/audit.rules
    line: '{{ item }}'
  with_items:
    - -a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
    - -a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
    - -a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
    - -a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
    - -a always,exit -F arch=b64 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod
    - -a always,exit -F arch=b32 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod

- name: "Ensure unsuccessful unauthorized file access attempts are collected"
  lineinfile:
      dest: /etc/audit/audit.rules
      line: '{{ item }}'
  with_items:
    - -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
    - -a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
    - -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access
    - -a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access

- name: "Ensure successful file system mounts are collected"
  lineinfile:
      dest: /etc/audit/audit.rules
      line: '{{ item }}'
  with_items:
    - -a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts
    - -a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts

- name: "Ensure file deletion events by users are collected"
  lineinfile:
    dest: /etc/audit/audit.rules
    line: '{{item}}'
  with_items:
    - -a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
    - -a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete

- name: "Ensure changes to system administration scope (sudoers) is collected"
  lineinfile:
      dest: /etc/audit/audit.rules
      line: '{{item}}'
  with_items:
    - -w /etc/sudoers -p wa -k scope
    - -w /etc/sudoers.d -p wa -k scope

- name: "Ensure system administrator actions (sudolog) are collected"
  lineinfile:
      dest: /etc/audit/audit.rules
      line: '-w /var/log/sudo.log -p wa -k actions'

- name: "Ensure kernel module loading and unloading is collected"
  lineinfile:
    dest: /etc/audit/audit.rules
    line: '{{item}}'
  with_items:
    - -w /sbin/insmod -p x -k modules
    - -w /sbin/rmmod -p x -k modules
    - -w /sbin/modprobe -p x -k modules
    - -a always,exit arch=b64 -S init_module -S delete_module -k modules

- name: "Ensure the audit configuration is immutable"
  replace:
    dest: /etc/audit/audit.rules
    regexp: '^-f 1'
    replace: '-e 2'
