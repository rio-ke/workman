---
- name: "Patching Play"
  hosts: master
  vars:
    #  - exclude_packages:
    #- exclude_packages: httpd*,vsftpd*
  tasks:
  - name: "Check updates available or not"
    shell: yum check-update -q | wc -l
    register: check_update_result

  - name: To show current kernel version
    shell: uname -r | sed 's/.x86_64//g'
    register: kernel_version

  - name: "Next version of kernel"
    shell: yum list available kernel -q | grep kernel | awk '{print $2}'
    register: update_kernel_version

  - name: "Update all packages without any exclude"
    yum:
      name: '*'
      state: latest
    when:
    - check_update_result.stdout != "0"
    - exclude_packages is not defined

  - name: "Update all packages with exclude Packages"
    yum:
      name: '*'
      state: latest
      exclude: "{{exclude_packages}}"
    when:
    - check_update_result.stdout != "0"
    - exclude_packages is defined

  - name: Restart server
    shell: sleep 1 && shutdown -r now "Reboot triggered by Ansible" && sleep 1
    async: 1
    poll: 0
    ignore_errors: true
    register: restart_state
    when: (check_update_result.stdout != "0" and exclude_packages is defined) or (check_update_result.stdout != "0" and exclude_packages is not defined)

  - name: "This play will wait for 3 minutes for system to come up"
    pause: minutes=3
    register: result_pause_state
    when: (check_update_result.stdout != "0" and exclude_packages is defined) or (check_update_result.stdout != "0" and exclude_packages is not defined)

  - name: check the client uptime
    shell: uptime
    register: up_time

  - debug:
      msg: "server Uptime is {{up_time.stdout}}"
