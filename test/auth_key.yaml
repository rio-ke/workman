---
- name: "To add authorized_key"
  hosts: all
  become: yes
  tasks:
    - name: "create user"
      user:
        name: "{{username}}"
        state: present
        shell: /bin/bash
      become: yes
      become_method: sudo

    - name: "Assign password for particular user"
      shell: "echo {{password}} | passwd --stdin {{username}}"
      become: yes
      become_method: sudo

    - name: Add devops user to the sudoers
      copy:
        dest: "/etc/sudoers.d/{{username}}"
        content: "{{username}}  ALL=(ALL)  NOPASSWD: ALL"

    - name: "ShareKey the user from local to remote machine"
      authorized_key:
        user: "{{username}}"
        key: "{{ lookup('file', '/home/{{ansible_user}}/.ssh/id_rsa.pub') }}"
        state: present
