---
- name: reboot
  hosts: vag
  tasks:
  - name: "This play is to restart the system using above status check"
    command: shutdown -r +1 "Rebooting System After Patching"
    async: 0
    poll: 0
    # when: reboot_status.stdout == "reboot needed"
    # register: reboot_started
    ignore_errors: true

  - name: "This play will wait for 3 minutes for system to come up"
    pause: minutes=3

    # Now we will run a local 'ansible -m ping' on this host until it returns.
    # This works with the existing ansible hosts inventory and so any custom ansible_ssh_hosts definitions are being used
  - name: check the system status
    local_action: shell ansible -u ansible -m ping {{ inventory_hostname }}
    register: result
    until: result.rc == 0
    retries: 30
    delay: 10

    # And finally, execute 'uptime' when the host is back.
  - name: check the client uptime
    shell: uptime

