---
- name: "Condition for Disks"
  assert:
    that:
    - mount.size_available > mount.size_total|float * 0.10
    msg: Disk space has reached 90% threshold
  vars:
    mount: "{{ ansible_mounts | selectattr('mount','equalto',item.mount) | list | first }}"
  with_items:
    - "{{ ansible_mounts }}"
  register: result
  ignore_errors: true
  no_log: true

- name: "create alert template"
  template:
    src: disk_alert.j2
    dest: /tmp/disk_alert.html
  when: result is failed

- name: "Mail Disk Alert"
  mail:
    host: "{{smtp_host}}"
    port: "{{smtp_port}}"
    username: "{{smtp_username}}"
    password: "{{smtp_password}}"
    to: "{{email_to}}"
    from: "{{email_from}}"
    subject: "{{client_name}} - {{ansible_hostname}} DISK ALERT"
    subtype: html
    body: >
     <!DOCTYPE html>
     <html>
     <head>
     <style type="text/css">
     .tftable {font-size:12px;color:#333333;width:50%;border-width: 1px;border-color: #729ea5;border-collapse: collapse;}
     .tftable th {font-size:18px;background-color:#acc8cc;border-width: 1px;padding: 8px;border-style: solid;border-color: #729ea5;text-align:center;}
     .tftable tr {background-color:#d4e3e5;}
     .tftable td {font-size:16px;border-width: 2px;padding: 8px;border-style: solid;border-color: #729ea5;text-align:center;}
     .tftable tr:hover {background-color:#ffffff;}
     #url_name{background-color: green; color: white; font-weight: bold; font-size:22px;}
     #ji3{background-color: #c9cda5}
     #ji5{background-color: #ffffff}
     #ji7{background-color: #ffffff}
     #url{background-color: #00b700;color: white;font-weight: bold;font-size:22px;}
     #heading{text-align:center;font-size:36px;color:red;margin-bottom:10px;}
     #heading1{align:center;font-size:12px;color:black;margin-bottom:10px;width:50%;margin-left:65%;}
     </style>
     </head>
     <body>
     <h3 id="heading">DISK SPACE ALERT!!!</h3>
     <h6 id="heading1">Disk thersold Limit is 90%</h6>
     <table class="tftable" border="1" align="center">
     <tr><td id="url" colspan="2">{{ansible_hostname}}</td></tr>
     {% for i in result.results | json_query('[]') %}
     {% if i.failed == true %}
     {% for q, w in i.item.items() %}
     {% if q == "mount" %}
     <tr><td id="ji{{loop.index}}">Mount Point</td><td id="ji{{loop.index}}">{{w}}</td></tr>
     {% endif %}
     {% if q == "size_available" %}
     <tr><td id="ji{{loop.index}}">Available Disk Space</td><td id="ji{{loop.index}}">{{(w/1024|pow(3))|round|int}} Gb</td></tr>
     {% endif %}
     {% if q == "size_total" %}
     <tr><td id="ji{{loop.index}}">Total Disk Space</td><td id="ji{{loop.index}}">{{(w/1024|pow(3))|round|int}} Gb</td></tr>
     {% endif %}
     {% endfor %}
     {% endif %}
     {% endfor %}
     </table>
     </body>
     </html>
  delegate_to: "{{ delegate_host | default('localhost') }}"
  run_once: True
  when: result is failed